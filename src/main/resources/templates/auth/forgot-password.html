<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quên mật khẩu - CinemaMax</title>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
        rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/forgot-password.css}" />
</head>

<body>
    <div class="forgot-password-container">
        <!-- Header Section -->
        <div class="header-section">
            <i class="bi bi-camera-reels cinema-icon"></i>
            <h1 class="page-title">Quên mật khẩu</h1>
            <p class="page-subtitle">Khôi phục tài khoản của bạn</p>
        </div>

        <!-- Form Container -->
        <div class="form-container">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <i class="bi bi-envelope"></i>
                </div>
                <div class="step inactive" id="step2">
                    <i class="bi bi-shield-check"></i>
                </div>
                <div class="step inactive" id="step3">
                    <i class="bi bi-key"></i>
                </div>
            </div>

            <!-- Alert Messages -->
            <div th:if="${message}" class="alert alert-info" id="message">
                <i class="bi bi-info-circle"></i>
                <span th:text="${message}"></span>
            </div>

            <div th:if="${success}" class="alert alert-success" id="success">
                <i class="bi bi-check-circle"></i>
                <span th:text="${success}"></span>
            </div>

            <div th:if="${error}" class="alert alert-danger" id="error">
                <i class="bi bi-exclamation-circle"></i>
                <span th:text="${error}"></span>
            </div>

            <!-- Step 1: Email Form -->
            <div class="form-section active" id="emailSection">
                <form th:action="@{/auth/forgot-password}" method="post" th:object="${forgotPasswordDTO}"
                    id="emailForm">
                    <div class="form-group">
                        <label for="email" class="form-label">
                            <i class="bi bi-envelope"></i> Địa chỉ email
                        </label>
                        <input type="email" id="email" th:field="*{email}" class="form-control"
                            placeholder="Nhập email đã đăng ký" required />
                    </div>
                </form>
            </div>

            <!-- Step 2: OTP Verification Form -->
            <div class="form-section" id="otpSection">
                <form th:action="@{/auth/verify-otp}" method="post" th:object="${forgotPasswordDTO}" id="otpForm">
                    <div class="form-group">
                        <label for="emailReadonly1" class="form-label">
                            <i class="bi bi-envelope"></i> Email
                        </label>
                        <input type="email" id="emailReadonly1" th:field="*{email}" class="form-control" readonly />
                    </div>

                    <div class="form-group">
                        <label for="otp" class="form-label">
                            <i class="bi bi-shield-check"></i> Mã xác thực OTP
                        </label>
                        <input type="text" id="otp" th:field="*{otp}" class="form-control" placeholder="Nhập mã 6 số"
                            pattern="\d{6}" maxlength="6" title="Vui lòng nhập 6 số" required />
                        <small class="form-text">
                            <i class="bi bi-info-circle"></i>
                            Mã OTP đã được gửi đến email của bạn
                        </small>
                    </div>

                    <button type="submit" class="btn btn-primary" id="verifyOtpBtn">
                        <i class="bi bi-check-circle"></i>
                        Xác thực OTP
                    </button>

                    <button type="button" class="btn btn-secondary" id="resendOtpBtn" style="margin-top: 10px;">
                        <i class="bi bi-arrow-clockwise"></i>
                        Gửi lại mã OTP
                    </button>
                </form>
            </div>

            <!-- Step 3: Reset Password Form -->
            <div class="form-section" id="passwordSection">
                <form th:action="@{/auth/reset-password}" method="post" th:object="${forgotPasswordDTO}"
                    id="passwordForm">
                    <div class="form-group">
                        <label for="emailReadonly2" class="form-label">
                            <i class="bi bi-envelope"></i> Email
                        </label>
                        <input type="email" id="emailReadonly2" th:field="*{email}" class="form-control" readonly />
                    </div>

                    <div class="form-group">
                        <label for="newPassword" class="form-label">
                            <i class="bi bi-key"></i> Mật khẩu mới
                        </label>
                        <input type="password" id="newPassword" th:field="*{newPassword}" class="form-control"
                            placeholder="Nhập mật khẩu mới" minlength="6" required />
                        <div class="password-strength" id="passwordStrength" style="display: none;">
                            <div class="strength-bar">
                                <div class="strength-fill"></div>
                            </div>
                            <span class="strength-text"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword" class="form-label">
                            <i class="bi bi-key-fill"></i> Xác nhận mật khẩu
                        </label>
                        <input type="password" id="confirmPassword" th:field="*{confirmPassword}" class="form-control"
                            placeholder="Nhập lại mật khẩu mới" required />
                        <small class="form-text" id="passwordMatch" style="display: none;"></small>
                    </div>

                    <button type="submit" class="btn btn-primary" id="resetPasswordBtn">
                        <i class="bi bi-check-circle"></i>
                        Đặt lại mật khẩu
                    </button>
                </form>
            </div>

            <!-- Back to Login -->
            <div class="back-to-login">
                <a th:href="@{/auth/login}">
                    <i class="bi bi-arrow-left"></i>
                    Quay lại đăng nhập
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Form elements
            const emailForm = document.getElementById('emailForm');
            const otpForm = document.getElementById('otpForm');
            const passwordForm = document.getElementById('passwordForm');

            // Section elements
            const emailSection = document.getElementById('emailSection');
            const otpSection = document.getElementById('otpSection');
            const passwordSection = document.getElementById('passwordSection');

            // Step indicators
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');

            // Message elements
            const messageDiv = document.getElementById('message');
            const successDiv = document.getElementById('success');
            const errorDiv = document.getElementById('error');

            // Button elements
            const sendOtpBtn = document.getElementById('sendOtpBtn');
            const verifyOtpBtn = document.getElementById('verifyOtpBtn');
            const resetPasswordBtn = document.getElementById('resetPasswordBtn');
            const resendOtpBtn = document.getElementById('resendOtpBtn');

            // Password strength checker
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const passwordStrength = document.getElementById('passwordStrength');
            const passwordMatch = document.getElementById('passwordMatch');

            // Function to update step indicators
            function updateStepIndicators(activeStep) {
                [step1, step2, step3].forEach((step, index) => {
                    step.classList.remove('active', 'completed', 'inactive');
                    if (index + 1 < activeStep) {
                        step.classList.add('completed');
                    } else if (index + 1 === activeStep) {
                        step.classList.add('active');
                    } else {
                        step.classList.add('inactive');
                    }
                });
            }

            // Function to show specific section
            function showSection(sectionToShow, stepNumber) {
                [emailSection, otpSection, passwordSection].forEach(section => {
                    section.classList.remove('active');
                });
                sectionToShow.classList.add('active');
                updateStepIndicators(stepNumber);
            }

            // Function to copy email between forms
            function copyEmailToForms(email) {
                document.getElementById('emailReadonly1').value = email;
                document.getElementById('emailReadonly2').value = email;
            }

            // Check initial state and show appropriate form
            function initializeForms() {
                if (messageDiv && messageDiv.textContent.includes('đã được gửi')) {
                    const emailValue = document.getElementById('email').value;
                    copyEmailToForms(emailValue);
                    showSection(otpSection, 2);
                } else if (successDiv && successDiv.textContent.includes('thành công')) {
                    const emailValue = document.getElementById('emailReadonly1').value || document.getElementById('email').value;
                    copyEmailToForms(emailValue);
                    showSection(passwordSection, 3);
                } else {
                    showSection(emailSection, 1);
                }
            }

            // Password strength checker
            function checkPasswordStrength(password) {
                const strength = {
                    score: 0,
                    text: '',
                    class: ''
                };

                if (password.length >= 8) strength.score++;
                if (/[a-z]/.test(password)) strength.score++;
                if (/[A-Z]/.test(password)) strength.score++;
                if (/[0-9]/.test(password)) strength.score++;
                if (/[^A-Za-z0-9]/.test(password)) strength.score++;

                if (strength.score < 3) {
                    strength.text = 'Mật khẩu yếu';
                    strength.class = 'strength-weak';
                } else if (strength.score < 4) {
                    strength.text = 'Mật khẩu trung bình';
                    strength.class = 'strength-medium';
                } else {
                    strength.text = 'Mật khẩu mạnh';
                    strength.class = 'strength-strong';
                }

                return strength;
            }

            // Password validation
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', function () {
                    const password = this.value;
                    if (password.length > 0) {
                        passwordStrength.style.display = 'block';
                        const strength = checkPasswordStrength(password);
                        passwordStrength.className = 'password-strength ' + strength.class;
                        passwordStrength.querySelector('.strength-text').textContent = strength.text;
                    } else {
                        passwordStrength.style.display = 'none';
                    }
                });
            }

            // Confirm password validation
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', function () {
                    const password = newPasswordInput.value;
                    const confirmPassword = this.value;

                    if (confirmPassword.length > 0) {
                        passwordMatch.style.display = 'block';
                        if (password === confirmPassword) {
                            passwordMatch.textContent = '✓ Mật khẩu khớp';
                            passwordMatch.style.color = '#4ade80';
                        } else {
                            passwordMatch.textContent = '✗ Mật khẩu không khớp';
                            passwordMatch.style.color = '#f87171';
                        }
                    } else {
                        passwordMatch.style.display = 'none';
                    }
                });
            }

            // Add loading states to buttons
            function addLoadingState(button) {
                button.classList.add('loading');
                button.disabled = true;
            }

            function removeLoadingState(button) {
                button.classList.remove('loading');
                button.disabled = false;
            }

            // Form submission handlers
            if (emailForm) {
                emailForm.addEventListener('submit', function () {
                    addLoadingState(sendOtpBtn);
                });
            }

            if (otpForm) {
                otpForm.addEventListener('submit', function () {
                    addLoadingState(verifyOtpBtn);
                });
            }

            if (passwordForm) {
                passwordForm.addEventListener('submit', function (e) {
                    const password = newPasswordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    if (password !== confirmPassword) {
                        e.preventDefault();
                        alert('Mật khẩu xác nhận không khớp!');
                        return;
                    }

                    addLoadingState(resetPasswordBtn);
                });
            }

            // Resend OTP functionality
            if (resendOtpBtn) {
                resendOtpBtn.addEventListener('click', function () {
                    const email = document.getElementById('emailReadonly1').value;
                    if (email) {
                        // Create a temporary form to resend OTP
                        const tempForm = document.createElement('form');
                        tempForm.method = 'POST';
                        tempForm.action = '/auth/forgot-password';

                        const emailInput = document.createElement('input');
                        emailInput.type = 'hidden';
                        emailInput.name = 'email';
                        emailInput.value = email;

                        tempForm.appendChild(emailInput);
                        document.body.appendChild(tempForm);

                        addLoadingState(resendOtpBtn);
                        tempForm.submit();
                    }
                });
            }

            // OTP input formatting
            const otpInput = document.getElementById('otp');
            if (otpInput) {
                otpInput.addEventListener('input', function () {
                    this.value = this.value.replace(/\D/g, '').substring(0, 6);
                });
            }

            // Initialize forms on page load
            initializeForms();
        });
    </script>
</body>

</html>